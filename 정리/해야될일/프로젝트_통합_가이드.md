# AI 일정 조율 시스템 - 프로젝트 통합 가이드

**최종 업데이트:** 2026-02-11

---

## 1. 프로젝트 개요

### 목표
그룹 채팅을 통해 자연스럽게 일정을 조율하고, AI가 합의된 일정을 자동으로 감지하여 제안하는 시스템

### 핵심 설계 철학: LLM 중심 (하드코딩 최소화)
- **날짜 계산**: LLM이 "금요일", "다음주 월요일" 등을 직접 계산
- **시간 해석**: LLM이 맥락으로 "6시 밥" → 18:00 판단
- **합의 감지**: LLM이 대화 흐름으로 자연스럽게 판단
- **장소 감지**: LLM이 "신라호텔 오후2시" → location: "신라호텔" 추출
- **프롬프트**: 한국어로 작성하여 문화적 맥락 전달 강화

### 아키텍처 원칙
- **모든 사용자는 DB를 주 데이터 소스로 사용** (구글 캘린더는 보조 표시용)
- `isGoogleUser` 분기 없이 동일한 코드 경로 사용
- `tabType`은 항상 `'local'`, `context`는 `'profile'`로 통일

---

## 2. 주요 파일 구조

### 프론트엔드 (client/src/)

| 파일 | 역할 |
|------|------|
| `SchedulingSystem.js` | PC 메인 시스템 (탭 관리, 전역 상태) |
| `components/mobile/MobileCalendarView.js` | 모바일 달력 (FullCalendar + 채팅 + 음성 + 카메라) |
| `components/mobile/MobileGroupsView.js` | 모바일 그룹(조율방) 뷰 |
| `components/mobile/MobileSettings.js` | 설정 페이지 (구글 연동, 동기화, 계정정보, 탈퇴) |
| `components/mobile/MobilePersonalInfoEdit.js` | 개인정보 수정 (이름, 전화, 주소, 비밀번호 변경) |
| `components/mobile/BottomNavigation.js` | 하단 네비 (새로고침/카메라/채팅/마이크) |
| `components/coordination/ConversationalRoomView.js` | 대화형 조율방 뷰 |
| `components/tabs/CoordinationTab/index.js` | 조율방 메인 컨테이너 |
| `components/modals/RoomCreationModal.js` | 조율방 생성 모달 |
| `components/modals/OptimalTimeModal.js` | 최적 시간 후보 모달 |
| `components/modals/CustomAlertModal.js` | 커스텀 알림/확인 모달 (Portal 사용) |
| `components/chat/SuggestionModal.js` | 일정 제안 모달 |
| `components/chat/GroupChat.js` | 그룹 채팅 |
| `hooks/useChat/enhanced.js` | 강화된 챗봇 훅 |
| `hooks/useChat/hooks/useEventAdd.js` | 일정 추가 훅 (프로필/이벤트 분기) |
| `hooks/useChat/prompts/unifiedPrompt.js` | AI 프롬프트 (location 포함) |

### 백엔드 (server/)

| 파일 | 역할 |
|------|------|
| `models/event.js` | Event 스키마 (location 필드 포함) |
| `models/ScheduleSuggestion.js` | 일정 제안 스키마 (optimalSource 필드 포함) |
| `controllers/eventController.js` | 일정 CRUD |
| `controllers/calendarController.js` | 구글 캘린더 동기화 (CRUD + syncFromGoogle 역동기화) |
| `controllers/coordinationController.js` | 조율방 컨트롤러 (최적시간 찾기 포함) |
| `controllers/coordinationMemberController.js` | 조율방 멤버 관리 (나가기/강퇴) |
| `controllers/chatController.js` | 채팅 컨트롤러 (제안 수락/거절) |
| `controllers/authController.js` | 인증 컨트롤러 (구글 링크 API, 계정 탈퇴 포함) |
| `controllers/ocrController.js` | Gemini 2.0 Flash 기반 OCR |
| `services/aiScheduleService.js` | 조율방 AI 분석 (자동 참석/불참) |
| `services/preferenceService.js` | 선호시간 충돌 체크 |

---

## 3. 이벤트 색상 구분

| 종류 | 색상 | 코드 |
|------|------|------|
| 선호시간 (가능) | 밝은파랑 | `#60a5fa` |
| 개인시간 (앱 일정) | 빨간색 | `#ef4444` |
| 예외 스케줄 | 보라색 | `#a855f7` |
| 구글 캘린더 일정 | 파란색 | `#3b82f6` |
| 조율 확정 일정 | 파란색 | `#3b82f6` |

---

## 4. 기술 참고

### AI 챗봇 인텐트

| 인텐트 | 설명 |
|--------|------|
| `add_preferred_time` | 선호시간 추가 (priority 1-3) |
| `add_personal_time` | 개인시간(불가능한 시간) 추가 |
| `add_event` | 일반 일정 추가 (location 포함) |
| `add_recurring_event` | 반복 일정 추가 |
| `delete_event` | 일정 삭제 |
| `delete_range` | 범위 삭제 |
| `edit_event` | 일정 수정 |

### Google Calendar 연동
- OAuth: `/api/auth/google/calendar-consent` → `/api/auth/google/calendar-callback`
- 구글 사용자도 DB가 주 데이터 소스, 구글 캘린더는 보조 표시 (파란색)
- 앱에서 만든 이벤트는 `extendedProperties.private.source = 'meetagent'` 태그 → 달력에서 중복 필터링
- **역동기화**: `POST /api/calendar/sync-from-google` — 구글에서 삭제된 일정을 앱 DB에서도 제거
  - 폴링: 30초 간격 자동 + 탭 포커스 시 즉시 실행
  - `User.updateOne` + `$pull` 사용 (Mongoose 버전 충돌 방지)

### OCR 시간표 인식
- 카메라 → `/api/ocr/analyze-schedule` → Gemini 2.0 Flash 분석 → 일정 자동 등록

### 음성 인식
- 마이크 → Web Speech API (ko-KR) → 텍스트 → 채팅 메시지 → AI 인텐트 파싱

### 자동 일정 충돌 감지
- 채팅에서 일정 제안 시 참여자별 기존 일정(personalTimes + events) 확인
- 충돌 있으면 자동 불참 처리 + 시스템 메시지
- "나도 갈게" 등 참석 의사 표현 시 수동 참석 변경

### Cross-Page Feature Pattern (하단 네비게이션)
- `?voice=start` → 음성 인식
- `?camera=open` → 카메라/OCR
- `?chat=open` → 채팅 열기

### CustomAlertModal 사용법
- `ReactDOM.createPortal`로 `document.body`에 렌더링 (z-index: 9999)
- Props: `isOpen`, `onClose`, `onConfirm`, `title`, `message`, `type`(info/success/warning/error), `showCancel`, `confirmText`, `cancelText`

### 초록불 (구글 연동 인디케이터)
- 5개 모바일 파일에서 `user?.google?.refreshToken` 유무로 판단
- 대상: MobileHeader, MobileDashboard, MobileGroupsView, MobileScheduleView, MobileCalendarView

---

## 5. 구글 계정 연동 기능 (구현 완료)

### 개요
일반(이메일/비밀번호) 로그인 사용자가 설정 페이지에서 구글 계정을 연동할 수 있다.
연동 후에는 구글 로그인으로도 접속 가능하며, 기존 데이터(일정, 선호시간, 조율방 등)가 그대로 유지된다.

### 핵심 원리

기존 데이터는 MongoDB의 User 문서에 저장되어 있고, User는 `firebaseUid`로 식별된다.
Firebase Auth는 하나의 계정에 여러 로그인 방법(이메일, 구글 등)을 **링크**할 수 있다.
따라서 구글 Provider를 기존 Firebase 계정에 링크하면 **firebaseUid가 변하지 않아** 데이터 이전이 필요 없다.

```
[기존]
Firebase 계정 (UID: abc123) ← 이메일/비밀번호 로그인
  → MongoDB User (firebaseUid: abc123) ← 모든 데이터 여기에 저장

[연동 후]
Firebase 계정 (UID: abc123) ← 이메일/비밀번호 OR 구글 로그인 (둘 다 가능)
  → MongoDB User (firebaseUid: abc123) ← 데이터 그대로 유지
  → + google.refreshToken 추가 → 구글 캘린더 연동 가능
```

### 데이터 흐름

```
[설정 페이지]
  사용자가 "구글 계정 연동하기" 클릭
       ↓
[Firebase Client SDK]
  linkWithPopup(auth.currentUser, googleProvider)
  → 구글 로그인 팝업 → 사용자 승인
       ↓
[프론트엔드]
  구글 credential 획득 (accessToken, idToken)
  → POST /api/auth/link-google { tokens }
       ↓
[백엔드]
  Google OAuth로 refreshToken 교환
  → user.google = { id, accessToken, refreshToken } 저장
       ↓
[완료]
  - 구글 로그인 가능
  - 구글 캘린더 파란색 표시
  - 기존 데이터 100% 유지
```

### 주의사항
1. **이미 구글로 가입한 다른 계정이 있는 경우**: Firebase에서 `auth/credential-already-in-use` 에러 발생 → "이미 다른 계정에 연결된 구글 계정입니다" 메시지 표시
2. **연동 해제**: Firebase에서 `unlink('google.com')` + MongoDB에서 `user.google = null` 처리
3. **로그인 인디케이터**: 연동 후 로고 우측 상단 원이 초록색(구글)으로 변경됨

---

## 6. 완료된 작업

### 2026-02-05
1. **isGoogleUser 분기 제거** (~12개 파일) - 모든 사용자 DB 기반
2. **채팅 장소 자동 감지** - unifiedPrompt.js에 location 추출 규칙 추가
3. **마이크 버튼 음성인식 연결** - `?voice=start` query param
4. **카메라 버튼 OCR 연결** - Gemini 2.0 Flash, `?camera=open` query param
5. **문서 통합** - 3개 → 1개
6. **모바일 헤더 정리** - 6개 버튼 → 2개 (프로필, 로그아웃)

### 2026-02-06
1. **채팅 참여자 추출 및 저장** - "형우랑 창정이랑 밥약속" → externalParticipants
2. **참여자 뱃지 디자인 통일** - 파란색 뱃지
3. **편집 모드 개선** - 삭제 버튼 편집 모드에서만, 취소 시 상태 복원
4. **일반 사용자 location 문제 해결**
5. **"다다음주" 날짜 계산 규칙 추가**
6. **구글 사용자 중복 표시 해결** - personalTimes 저장 스킵, Google Calendar만 저장

### 2026-02-09
1. **조율방 생성 모달 모바일 최적화** - 중앙 배치, 스크롤 가능, 85% 너비
2. **최적 시간표 로직 개선** - optimalSource 필드 추가, 선호시간 없으면 차단, 중복 방지, 삭제 시 복원
3. **일정 삭제 vs 불참 분기 처리** - 참석자 0명이면 삭제, 1명 이상이면 불참 (3개 코드 경로 모두 수정)
4. **조율방 모드 순서 변경** - 대화형 모드 디폴트 + 왼쪽, 표준 모드일 때만 시간표 설정 표시
5. **방 생성 모달 버그 수정** - CustomAlertModal prop 수정(show→isOpen), 최소 인원 1명, 여백 추가
6. **방 나가기 기능 수정** - 혼자 남은 방장이 나가면 방 삭제, window.confirm → CustomAlertModal 변환
7. **CustomAlertModal Portal 적용** - ReactDOM.createPortal로 document.body에 렌더링, #root z-index 설정
8. **자동 일정 충돌 감지** - 제안 시 참여자 기존 일정과 충돌 체크 → 자동 불참 처리
9. **구글 연동 관련 수정** (코드 적용 완료, 실사용 테스트 필요):
   - 빨간+파란 중복 표시 방지: `calendarController.js`에 `source = 'meetagent'` 태그, `MobileCalendarView.js`에서 필터링
   - 상단 초록불: 5개 파일에서 `localStorage loginMethod` → `user?.google?.refreshToken`으로 변경
   - 수동 동기화 버튼: `syncEventsToGoogle`이 personalTimes + Event 컬렉션 둘 다 읽도록 수정, `MobileSettings.js`에 동기화 버튼 + 연동 콜백 시 자동 동기화

### 2026-02-10
1. **구글 로그인 사용자 일정 추가 400 에러 수정** - `useEventAdd.js`에서 기존 personalTimes를 PUT할 때 `isGoogleEvent: true`인 구글 캘린더 항목 필터링 추가

### 2026-02-11
1. **SuggestionModal React key 경고 수정** - `key={response.user._id}` → `key={response.user?._id || response.user || idx}` (user가 ObjectId 문자열일 때 ._id undefined 방지)
2. **설정 페이지 개편 완료**
   - 달력 페이지에서 개인정보 수정 버튼 제거
   - 설정 페이지 "계정정보" 섹션에 개인정보 수정(MobilePersonalInfoEdit) 통합
   - 4개 모바일 뷰 파일 프로필 버튼 → `/mobile/settings`로 이동하도록 수정 (MobileDashboard, MobileGroupsView, MobileScheduleView, MobileCalendarView)
   - 계정 탈퇴 기능 복원: `server/routes/auth.js` 라우트 주석 해제 + MobileSettings.js에 탈퇴 버튼/확인 모달 추가
3. **비밀번호 변경 기능 추가** - MobilePersonalInfoEdit.js 이메일 필드 바로 아래에 배치, 이메일 로그인 사용자에게만 표시, Firebase `updatePassword()` + `reauthenticateWithCredential()` 사용
4. **구글 캘린더 삭제 역동기화 구현 완료**
   - `calendarController.js`에 `syncFromGoogle` 엔드포인트 신규 추가
   - `createGoogleCalendarEvent`에서 구글 이벤트 생성 후 `googleEventId`를 DB personalTimes에 저장하도록 수정
   - `syncEventsToGoogleInternal`에서 모든 이벤트(suggestionId 유무 무관)에 `googleEventId` 저장하도록 수정
   - `User.updateOne` + `$pull` 사용 (Mongoose 버전 충돌 방지)
   - 조율방 확정 일정이 구글에서 삭제된 경우 불참 처리 연동
   - `server/routes/calendar.js`에 `POST /sync-from-google` 라우트 추가
5. **역동기화 실시간 폴링 추가**
   - MobileCalendarView.js에 `syncFromGoogleLight` 함수 추가
   - 30초 간격 자동 폴링 (setInterval)
   - 탭 포커스 시 즉시 동기화 (visibilitychange 이벤트)
   - 삭제 감지 시 personalTimes + googleCalendarEvents 자동 새로고침
6. **MobileSettings.js 역동기화 에러 처리** - `syncRes.ok` 체크 추가, 500 에러 시 JSON 파싱 오류 방지
7. **AI "중복 일정으로 스킵" 오류 수정 완료** - `aiScheduleService.js` 중복 판단: 같은 날짜 + 같은 시작시간 + 같은 제목(대소문자 무시)일 때만 중복 처리
8. **일정 소유권 이전 구현 완료** - `chatController.js` rejectSuggestion에서 suggestedBy→null, deleteSuggestion에서 null이면 accepted 멤버 누구나 삭제 가능, `SuggestionModal.js` isOwner 함수 수정
9. **캘린더 색상 범례 추가 완료** - `MobileCalendarView.js` 빨간 dot "앱 일정" + 파란 dot "구글 캘린더" 범례 표시
10. **구글 전환 사용자 역동기화 수정** - `createGoogleCalendarEvent`, `syncEventsToGoogleInternal`에서 `on('tokens')` 제거 → 수동 토큰 갱신 + `User.updateOne` 사용, 토큰 경쟁 조건 해결
11. **sync-from-google 중복 호출 방지** - `syncLockRef`로 동시 호출 차단, `removedSuggestionIds` 중복 제거
12. **구글 삭제 시 채팅방 알림 개선** - 아무도 수락 안 한 상태면 삭제 + "삭제됨" 메시지, 다른 수락자 있으면 불참 + 소유권 이전 + "불참" 메시지
13. **extend "같은 값" 오판 수정** - 프롬프트에 extend 타겟 선택 시 날짜 우선 규칙 강화, 코드에 디버그 로그 + 경고 메시지 추가 (`aiScheduleService.js`, `scheduleAnalysis.js`)
14. **날짜 계산 한국식 주 적용** - 주 계산을 일요일 시작 → 월요일 시작으로 변경, 모든 달력 인덱스 참조 업데이트 (`scheduleAnalysis.js`)
15. **시간 해석 모호성 프롬프트 강화** - "X시" 오전/오후 판단 규칙 추가: 기존 일정 시간대 기준, 활동 맥락 기준, 1~6시 맥락 의존 규칙 (`scheduleAnalysis.js`)
16. **window.confirm → CustomAlertModal 전체 변환 완료** - 11개 파일 17개 호출 모두 교체:
   - `AuthScreen.js` (1), `AdminUserManagement.js` (3), `AdminRoomManagement.js` (2)
   - `TimetableGrid.js` (1), `EventDetailModal.js` (1), `MobileCalendarView.js` (1)
   - `SuggestionModal.js` (1), `MobileScheduleEdit.js` (1)
   - `MemberStatsModal.js` (1), `MemberLogsModal.js` (1), `RoomManagementModal.js` (4)

---

## 7. 미완료 작업 (TODO)

### 모든 TODO 완료! (2026-02-11 확인)
  - `MemberStatsModal.js` (이월시간 삭제)
  - `MemberLogsModal.js` (로그 삭제)
  - `RoomManagementModal.js` (로그 초기화, 멤버 제거, 방 나가기, 방 삭제)
