================================================================================
                      자동배정 알고리즘 기능 설명서
================================================================================

📅 작성일: 2025-12-09
🎯 목적: 자동배정 알고리즘의 각 모드별 동작 방식과 주요 기능 설명

================================================================================
1. 알고리즘 개요
================================================================================

[목적]
방(Room)에 속한 여러 학생(멤버)들에게 주당 최소 시간(기본 3시간)을 자동으로 배정하는
스케줄링 시스템입니다.

[핵심 원리]
- 방장의 가능 시간대를 기준으로 타임테이블 생성
- 각 학생의 선호시간과 개인시간(예외시간)을 고려
- 선택한 모드에 따라 다른 전략으로 배정
- 충돌 시 우선순위, 가용 슬롯 수 등을 고려하여 공평하게 배정

[주요 특징]
✓ LLM/AI 사용 없음 - 순수 규칙 기반 알고리즘
✓ 30분 단위 슬롯 관리
✓ 다중 주(2주 이상) 배정 지원
✓ 이월(carry over) 시간 자동 관리
✓ 4가지 배정 모드 제공


================================================================================
2. 배정 모드별 동작 방식
================================================================================

┌─────────────────────────────────────────────────────────────────┐
│ [1] 일반 모드 (Normal Mode)                                      │
└─────────────────────────────────────────────────────────────────┘

🎯 전략: 시간 순서 우선 배정

📌 동작 방식:
  1. 멤버 정렬 기준
     - 우선순위가 높은 사람부터
     - 선택지가 적은 사람부터 (가용 슬롯이 적은 사람 우선)

  2. 각 멤버마다 최적의 시간대 찾기
     - 연속된 블록 우선 (수업 분할 최소화)
     - 긴 블록 우선 (예: 2시간 블록 > 1시간 블록 2개)
     - 이른 시간부터 배정 (예: 09:00부터 채워나감)

  3. 필요량 충족할 때까지 반복

📊 예시:
  A학생: 월~금 09:00-18:00 선호, 3시간 필요
  B학생: 월~금 14:00-18:00 선호, 3시간 필요

  → B가 선택지가 적으므로 B부터 배정
  → B: 월 14:00-17:00 배정
  → A: 월 09:00-12:00 배정

✅ 장점:
  - 시간 분할 최소화 (연속된 시간대 우선)
  - 공평성 확보 (선택지 적은 멤버 우선)
  - 예측 가능한 결과 (이른 시간부터 순서대로)

❌ 단점:
  - 이동 거리를 고려하지 않음
  - 실제 이동 시간을 반영하지 않음


┌─────────────────────────────────────────────────────────────────┐
│ [2] 선착순 모드 (First Come First Served)                        │
└─────────────────────────────────────────────────────────────────┘

🎯 전략: 가입 순서대로 우선 배정

📌 동작 방식:
  1. 멤버 정렬 기준
     - 방에 먼저 가입한 사람부터 (joinedAt 빠른 순)
     - 우선순위가 높은 사람부터

  2. 배정 로직은 일반 모드와 동일
     - 연속된 블록 우선
     - 이른 시간부터 배정

📊 예시:
  A학생: 2024-01-01 가입, 3시간 필요
  B학생: 2024-01-02 가입, 3시간 필요
  둘 다 월~금 09:00-18:00 선호

  → A가 먼저 가입했으므로 A부터 배정
  → A: 월 09:00-12:00 배정
  → B: 월 12:00-15:00 배정

✅ 장점:
  - 먼저 가입한 사용자에게 유리
  - 명확하고 공정한 기준 (선착순)

❌ 단점:
  - 나중에 가입한 사용자에게 불리
  - 선택지 적은 멤버가 우선 배정되지 않음


┌─────────────────────────────────────────────────────────────────┐
│ [3] 오늘부터 모드 (From Today)                                    │
└─────────────────────────────────────────────────────────────────┘

🎯 전략: 과거 날짜는 제외하고 배정

📌 동작 방식:
  1. 타임테이블 생성 후 오늘 이전 날짜 필터링
     - 과거 날짜의 슬롯은 모두 제거
     - 오늘부터 미래 날짜만 배정 대상

  2. 배정 로직은 일반 모드 또는 선착순 모드와 동일

📊 예시:
  오늘: 2024-01-10 (수요일)
  배정 범위: 2024-01-08 (월) ~ 2024-01-12 (금)

  → 월(1/8), 화(1/9)는 과거이므로 제외
  → 수(1/10), 목(1/11), 금(1/12)만 배정

✅ 장점:
  - 실시간 배정에 유용 (이미 지나간 시간 제외)
  - 일정 변경 시 유용

❌ 단점:
  - 배정 가능한 시간대가 줄어듦
  - 주 초에 실행 시 배정 시간 부족 가능성


┌─────────────────────────────────────────────────────────────────┐
│ [4] 대중교통 모드 (Public Transport / Driving / Walking)        │
└─────────────────────────────────────────────────────────────────┘

🎯 전략: 거리 순서 우선 배정 (이동시간 최소화)

📌 동작 방식:
  1. 요일별로 처리
     - 월요일 → 화요일 → ... → 금요일 순서

  2. 각 요일마다:
     ① 시작 위치: 방장의 위치

     ② Google Maps API로 이동시간 계산
        - 현재 위치에서 모든 후보 학생까지의 이동시간 조회
        - 이동수단별 시간 (대중교통/자동차/도보)

     ③ 가장 가까운 학생부터 확인
        조건 1: 이동시간 + 수업시간 ≤ 선호시간 종료시간
        조건 2: 예외시간(점심, 저녁 등) 회피

     ④ 예외시간 충돌 시 자동 조정
        - 예: 11:40 도착 → 12:00-13:00 점심시간
        - 자동으로 13:00부터 배정

     ⑤ 배정 후 현재 위치 업데이트
        - 배정된 학생의 위치로 이동
        - 다음 가장 가까운 학생 찾기

     ⑥ 필요량 충족할 때까지 반복

📊 예시:
  방장 위치: 서울역
  A학생 위치: 강남역 (이동 30분)
  B학생 위치: 신촌역 (이동 1시간 30분)
  C학생 위치: 홍대입구역 (이동 1시간 50분)

  월요일 배정:
  ① 방장 위치(서울역) → A(강남역) 이동 30분
     - 13:00 시작 → 13:30 도착 → 14:00~15:00 배정 ✅

  ② A 위치(강남역) → B(신촌역) 이동 1시간 30분
     - 15:00 시작 → 16:30 도착
     - 선호시간 종료 17:00까지 30분 부족 ❌

  ③ A 위치(강남역) → C(홍대입구역) 이동 50분
     - 15:00 시작 → 15:50 도착 → 16:00~17:00 배정 ✅

  화요일 배정:
  ① C 위치(홍대입구역) → B(신촌역) 이동 20분
     - 13:00 시작 → 13:20 도착 → 14:00~15:00 배정 ✅

  결과:
  - A: 월 14:00-15:00 (1시간)
  - C: 월 16:00-17:00 (1시간)
  - B: 화 14:00-15:00 (1시간)

✅ 장점:
  - 이동 시간 최소화 (실제 교통편 기반)
  - 이동 가능성 고려 (현실적인 배정)
  - 예외시간 자동 회피 (점심시간 등)

❌ 단점:
  - Google Maps API 호출 필요 (비용 발생)
  - 네트워크 의존성
  - 처리 시간 증가 (API 호출 때문)
  - 주소 정보 필수 (학생들이 주소를 등록해야 함)

💡 최적화:
  - 캐싱 시스템: 같은 출발지-목적지 조합은 24시간 재사용
  - 배치 처리: 최대 25개 목적지를 1번의 API 호출로 처리


================================================================================
3. 주요 기능별 동작 방식
================================================================================

┌─────────────────────────────────────────────────────────────────┐
│ [1] 우선순위 처리                                                │
└─────────────────────────────────────────────────────────────────┘

📌 우선순위 레벨:
  1 = 최하 우선순위
  2 = 낮은 우선순위
  3 = 중간 우선순위 (기본값)
  4 = 높은 우선순위
  5 = 최고 우선순위

📌 우선순위 적용:
  - 같은 시간대를 원하는 멤버가 여러 명일 때
  - 우선순위가 높은 사람이 먼저 배정
  - 우선순위가 같으면 "선택지 적은 사람" 또는 "먼저 가입한 사람"이 우선

📊 예시:
  월요일 09:00-10:00 슬롯에 3명이 신청
  - A: 우선순위 5 (최고)
  - B: 우선순위 3 (중간)
  - C: 우선순위 3 (중간)

  → A가 자동으로 배정 (최고 우선순위)
  → B와 C는 충돌 상태 (같은 우선순위)
  → 충돌은 자동 회피 (다른 시간대에 배정)


┌─────────────────────────────────────────────────────────────────┐
│ [2] 충돌 해결                                                    │
└─────────────────────────────────────────────────────────────────┘

📌 충돌 정의:
  같은 시간대를 2명 이상이 원하고, 최고 우선순위가 같을 때

📌 충돌 해결 방식:
  **자동 회피** (현재 구현)
  - 충돌 슬롯은 배정하지 않음
  - 충돌 멤버들은 다른 시간대에 배정
  - 선택지 적은 멤버가 우선 배정되므로 공평성 확보

📊 예시:
  월요일 09:00-10:00 슬롯에 B와 C가 충돌 (둘 다 우선순위 3)

  B의 가능한 시간대: 월 09:00, 화 14:00 (2개)
  C의 가능한 시간대: 월 09:00, 화 14:00, 수 10:00, 목 15:00 (4개)

  → B가 선택지가 적으므로 B부터 배정
  → B: 화 14:00에 배정
  → C: 월 09:00에 배정 (이제 충돌 없음)


┌─────────────────────────────────────────────────────────────────┐
│ [3] 이월(Carry Over) 시간 처리                                   │
└─────────────────────────────────────────────────────────────────┘

📌 이월 발생 상황:
  - 어떤 멤버가 필요한 시간을 모두 배정받지 못한 경우
  - 예: 3시간 필요한데 2시간만 배정됨 → 1시간 이월

📌 이월 처리 방식:
  1. 다음 주 배정 시 우선권 부여
     - 이월 시간을 필요량에 추가
     - 예: 다음 주에는 3시간 + 1시간 = 4시간 필요

  2. 빈 슬롯 우선 배정
     - 아직 아무도 배정받지 않은 시간대에 우선 배정

  3. 연속 이월 모니터링
     - 2주 연속 이월 시 needsIntervention 플래그 설정
     - 관리자에게 알림 (수동 개입 필요)

📊 예시:
  1주차:
  - A: 3시간 필요 → 2시간 배정 → 1시간 이월

  2주차:
  - A: 3시간 + 1시간(이월) = 4시간 필요
  - 빈 슬롯 우선 확보
  - 4시간 배정 성공 → 이월 해소

  만약 2주차에도 부족하면:
  - A: 1시간 다시 이월
  - needsIntervention = true (관리자 확인 필요)


┌─────────────────────────────────────────────────────────────────┐
│ [4] 예외시간(개인시간) 처리                                      │
└─────────────────────────────────────────────────────────────────┘

📌 예외시간이란:
  - 학생이 수업을 받을 수 없는 시간대
  - 예: 점심시간(12:00-13:00), 저녁시간(18:00-19:00), 개인 일정 등

📌 예외시간 처리:
  1. 일반 모드
     - 예외시간 슬롯은 타임테이블에서 제거
     - 배정 대상에서 제외

  2. 대중교통 모드
     - 예외시간 충돌 시 자동으로 예외시간 이후로 이동
     - 예: 11:40 도착 → 12:00-13:00 점심 → 13:00부터 배정

📊 예시 (대중교통 모드):
  A 학생의 수업: 11:00 종료
  B 학생까지 이동시간: 40분 (도착 11:40)
  B 학생의 예외시간: 12:00-13:00 (점심)

  처리 과정:
  ① 11:40 도착 예정
  ② 12:00부터 13:00까지 점심시간 (예외시간 충돌 감지)
  ③ 자동으로 13:00부터 배정
  ④ 대기시간 1시간 20분 발생 (11:40 → 13:00)
  ⑤ 결과: 13:00-14:00 배정 ✅


┌─────────────────────────────────────────────────────────────────┐
│ [5] 다중 주(Multi-Week) 배정                                     │
└─────────────────────────────────────────────────────────────────┘

📌 다중 주 배정이란:
  - 한 번에 여러 주의 일정을 자동으로 배정
  - 예: 4주 치 일정을 한 번에 배정

📌 다중 주 처리 방식:
  1. 각 주마다 개별적으로 배정
     - 1주차 배정 → 결과 저장
     - 2주차 배정 → 결과 저장
     - 3주차 배정 → 결과 저장
     - 4주차 배정 → 결과 저장

  2. 이월 시간 자동 전달
     - 1주차에서 부족한 시간 → 2주차로 이월
     - 2주차에서 부족한 시간 → 3주차로 이월
     - ...

  3. 최종 결과 통합
     - 모든 주의 배정 결과를 하나로 병합
     - 전체 이월 정보 포함

📊 예시:
  4주 배정 (주당 3시간):

  1주차: A 2시간 배정 → 1시간 이월
  2주차: A 3시간 + 1시간(이월) = 4시간 배정 → 이월 해소
  3주차: A 3시간 배정 ✅
  4주차: A 3시간 배정 ✅

  전체: A는 총 12시간 배정 (3시간 * 4주)


┌─────────────────────────────────────────────────────────────────┐
│ [6] 자동 확정 시스템                                              │
└─────────────────────────────────────────────────────────────────┘

📌 자동 확정이란:
  - 배정된 시간을 자동으로 학생들의 개인 일정에 추가
  - 방장이 수동으로 확정하지 않아도 일정 시간 후 자동 확정

📌 자동 확정 처리:
  1. 자동 배정 실행 시
     - autoConfirmAt 시간 설정 (예: 48시간 후)

  2. Cron Job (매 1분마다 실행)
     - autoConfirmAt 시간이 지난 방 찾기
     - 자동으로 확정 처리

  3. 확정 처리 내용
     - 배정된 슬롯을 학생들의 personalTimes에 추가
     - 학생들의 선호시간(defaultSchedule)에서 배정된 부분 제거
     - autoConfirmAt 해제

📊 예시:
  2024-01-01 10:00 - 자동 배정 실행
  → autoConfirmAt = 2024-01-03 10:00 (48시간 후)

  2024-01-03 10:01 - Cron Job 실행
  → autoConfirmAt 시간 경과 확인
  → 자동 확정 처리
  → 학생들의 개인 일정에 추가


================================================================================
4. 실제 사용 시나리오
================================================================================

┌─────────────────────────────────────────────────────────────────┐
│ 시나리오 1: 일반 모드 - 기본적인 배정                            │
└─────────────────────────────────────────────────────────────────┘

상황:
  - 방장: 월~금 09:00-18:00 가능
  - A학생: 월~금 09:00-18:00 선호, 우선순위 3
  - B학생: 월~금 14:00-18:00 선호, 우선순위 3
  - C학생: 월~금 09:00-12:00 선호, 우선순위 4
  - 모두 주당 3시간 필요

배정 결과:
  1. C부터 배정 (우선순위 4로 가장 높음)
     → C: 월 09:00-12:00 (3시간) ✅

  2. B 배정 (선택지가 A보다 적음: 14:00-18:00만 가능)
     → B: 월 14:00-17:00 (3시간) ✅

  3. A 배정 (남은 시간대 중 최적 블록)
     → A: 화 09:00-12:00 (3시간) ✅

최종:
  - 월요일: C(09:00-12:00), B(14:00-17:00)
  - 화요일: A(09:00-12:00)


┌─────────────────────────────────────────────────────────────────┐
│ 시나리오 2: 대중교통 모드 - 이동시간 최소화                      │
└─────────────────────────────────────────────────────────────────┘

상황:
  - 방장 위치: 서울역
  - A학생 위치: 강남역 (이동 30분), 월~금 13:00-17:00 선호
  - B학생 위치: 신촌역 (이동 1.5시간), 월~금 13:00-17:00 선호
  - C학생 위치: 홍대입구역 (이동 1시간 50분), 월~금 13:00-17:00 선호
  - 모두 주당 3시간 필요 (수업 1시간씩)

배정 결과:
  월요일:
  ① 방장(서울역) → A(강남역) 30분
     - 13:00 출발 → 13:30 도착 → 14:00-15:00 배정 ✅

  ② A(강남역) → B(신촌역) 1시간 30분
     - 15:00 출발 → 16:30 도착
     - 선호시간 종료 17:00까지 30분 부족 ❌ 스킵

  ③ A(강남역) → C(홍대입구역) 50분
     - 15:00 출발 → 15:50 도착 → 16:00-17:00 배정 ✅

  화요일:
  ① C(홍대입구역) → B(신촌역) 20분
     - 13:00 출발 → 13:20 도착 → 14:00-15:00 배정 ✅

  수요일:
  ① B(신촌역) → A(강남역) 1시간 20분
     - 13:00 출발 → 14:20 도착 → 15:00-16:00 배정 ✅

  목요일:
  ① A(강남역) → C(홍대입구역) 50분
     - 13:00 출발 → 13:50 도착 → 14:00-15:00 배정 ✅

  금요일:
  ① C(홍대입구역) → B(신촌역) 20분
     - 13:00 출발 → 13:20 도착 → 14:00-15:00 배정 ✅

최종:
  - A: 월(14:00-15:00), 수(15:00-16:00) = 2시간 → 1시간 이월
  - B: 화(14:00-15:00), 금(14:00-15:00) = 2시간 → 1시간 이월
  - C: 월(16:00-17:00), 목(14:00-15:00) = 2시간 → 1시간 이월


┌─────────────────────────────────────────────────────────────────┐
│ 시나리오 3: 예외시간 회피 (대중교통 모드)                        │
└─────────────────────────────────────────────────────────────────┘

상황:
  - 방장 위치: 서울역
  - A학생 위치: 강남역 (이동 30분)
  - A 선호시간: 월~금 09:00-18:00
  - A 예외시간: 12:00-13:00 (점심), 18:00-19:00 (저녁)
  - 수업시간: 1시간

배정 시도:
  월요일:
  ① 방장(서울역) → A(강남역) 30분
     - 10:00 출발 → 10:30 도착
     - 11:00-12:00 배정 시도
     - 예외시간 충돌 없음 → 11:00-12:00 배정 ✅

  ② 다음 배정
     - 12:00 출발 → 12:30 도착
     - 13:00-14:00 배정 시도
     - 12:00-13:00 점심시간 충돌 감지!
     - 자동으로 13:00 이후로 이동
     - 13:00-14:00 배정 ✅ (대기시간 30분)

  ③ 다음 배정
     - 14:00 출발 → 14:30 도착
     - 15:00-16:00 배정 시도
     - 예외시간 충돌 없음 → 15:00-16:00 배정 ✅

최종:
  - A: 월(11:00-12:00), 월(13:00-14:00), 월(15:00-16:00) = 3시간 ✅


================================================================================
5. 제약사항 및 주의사항
================================================================================

[제약사항]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 선호시간 필수
   - 모든 멤버는 최소 1개 이상의 선호시간을 등록해야 함
   - 선호시간이 없으면 배정 불가

2. 30분 단위
   - 모든 시간은 30분 단위로 관리
   - 예: 09:00, 09:30, 10:00, ...

3. 방장의 가능 시간대가 기준
   - 방장이 불가능한 시간대는 배정 대상에서 제외
   - 방장의 선호시간이 타임테이블의 기준

4. 대중교통 모드는 주소 필수
   - 대중교통/자동차/도보 모드는 모든 멤버가 주소를 등록해야 함
   - 주소가 없으면 해당 멤버는 배정 불가

5. 충돌 시 자동 회피
   - 협의(negotiation) 시스템은 현재 비활성화
   - 충돌 슬롯은 배정하지 않음


[주의사항]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 이월이 누적되면
   - 2주 연속 이월 시 needsIntervention 플래그 설정
   - 관리자 또는 방장이 수동으로 확인 필요
   - 선호시간 조정 또는 필요시간 감소 검토

2. 대중교통 모드 비용
   - Google Maps API 호출 비용 발생
   - 캐싱 시스템으로 비용 절감 (24시간 재사용)
   - 배치 처리로 API 호출 횟수 최소화

3. 자동 확정 시간
   - 기본값: 48시간 (실험용은 1분)
   - 방장이 직접 확정할 수도 있음
   - 자동 확정 전에 배정 결과 확인 권장

4. 다중 주 배정 시간
   - 주 수가 많을수록 처리 시간 증가
   - 대중교통 모드는 특히 시간이 오래 걸림
   - 권장: 4주 이하


================================================================================
6. 모드 선택 가이드
================================================================================

[어떤 모드를 선택해야 할까?]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 일반 모드 (Normal Mode)
   권장 상황:
   - 온라인 수업 또는 화상 회의
   - 이동이 필요 없는 경우
   - 빠른 배정이 필요한 경우
   - 이동 거리를 고려할 필요가 없는 경우

✅ 선착순 모드 (First Come First Served)
   권장 상황:
   - 먼저 가입한 사용자에게 우선권을 주고 싶을 때
   - 명확하고 공정한 기준이 필요할 때
   - 가입 순서가 중요한 커뮤니티

✅ 오늘부터 모드 (From Today)
   권장 상황:
   - 주 중간에 일정을 재배정해야 할 때
   - 과거 날짜는 제외하고 싶을 때
   - 실시간 일정 조정이 필요할 때

✅ 대중교통 모드 (Public Transport / Driving / Walking)
   권장 상황:
   - 대면 수업 또는 오프라인 미팅
   - 학생들이 다른 지역에 거주
   - 이동 시간 최소화가 중요한 경우
   - 실제 이동 가능성을 고려해야 할 때


[모드별 성능 비교]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

처리 속도:
  일반 모드 > 선착순 모드 > 오늘부터 모드 >> 대중교통 모드

비용:
  일반/선착순/오늘부터 모드: 무료
  대중교통 모드: Google Maps API 비용 발생

정확도 (이동 고려):
  대중교통 모드 > 일반 모드 = 선착순 모드 = 오늘부터 모드

공평성:
  일반 모드 > 선착순 모드 > 대중교통 모드 > 오늘부터 모드


================================================================================
문서 끝
================================================================================
