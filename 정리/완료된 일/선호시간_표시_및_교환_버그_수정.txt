================================================================================
선호시간 표시 및 일정 교환 버그 수정 작업 기록
================================================================================
작성일: 2025-12-01
상태: 진행 중

================================================================================
                               문제 요약
================================================================================

1. 챗봇으로 추가한 선호시간이 "약속"으로 표시됨
   - 프로필 탭: 병합 모드에서 exception의 title("선호시간")이 그대로 표시됨
   - 일정맞추기 탭: 조원 시간표에서도 "약속"으로 표시됨

2. 일정 교환 시 "방장과 당신의 선호 시간이 겹치지 않습니다" 에러
   - 챗봇으로 추가한 선호시간이 ISO 형식으로 저장됨
   - 버튼으로 추가한 선호시간은 HH:MM 형식
   - 시간대 변환 문제로 겹치지 않는다고 판단됨

================================================================================
                            ✅ 완료된 작업
================================================================================

1. DetailTimeGrid 병합 모드 수정
   파일: client/src/components/calendar/DetailTimeGrid/index.js
   수정: Line 1506-1507
   내용: exception의 title 대신 priority 레이블(선호/보통/조정가능) 표시

2. MergedWeekView 수정 (일정맞추기 탭 - 병합 모드)
   파일: client/src/components/tabs/ScheduleGridSelector/components/MergedWeekView.js
   수정: Line 128-131
   내용: exception도 priority 레이블로 표시, 휴무/휴일은 원래 title 유지

3. DetailedWeekView 수정 (일정맞추기 탭 - 분할 모드)
   파일: client/src/components/tabs/ScheduleGridSelector/components/DetailedWeekView.js
   수정: Line 139-142
   내용: exception도 priority 레이블로 표시, 휴무/휴일은 원래 title 유지

4. coordinationExchangeController 시간 형식 처리 추가
   파일: server/controllers/coordinationExchangeController.js
   수정: mergeSlots 함수 내 normalizeTime 헬퍼 함수 추가
   내용: ISO 형식("2025-12-03T00:00:00.000Z")과 HH:MM 형식("09:00") 모두 처리

5. 디버그 로그 추가
   파일: server/controllers/coordinationExchangeController.js
   내용:
   - Member schedules 실제 데이터 출력
   - 시간 병합 결과 출력 (방장/멤버)
   - normalizeTime 함수 입력/출력 로그

================================================================================
                         🔄 진행 중인 작업 (현재 막힘)
================================================================================

문제: 멤버의 시간이 00:00-00:00으로 변환됨

현재 상황:
- DB 저장 데이터: "2025-12-03T00:00:00.000Z" ~ "2025-12-03T03:00:00.000Z"
  (UTC 00:00-03:00 = 한국시간 09:00-12:00)
- 방장 데이터: "09:00" ~ "12:00" (HH:MM 형식)
- normalizeTime 함수가 00:00-00:00을 반환 중

시도한 해결책:
1. getUTCHours() 사용 → UTC 시간 그대로 00:00-03:00 (방장과 안 겹침)
2. getHours() 사용 → 로컬 시간 09:00-12:00 (예상)
   ❌ 하지만 여전히 00:00-00:00 출력됨

다음 단계:
- normalizeTime 함수의 디버그 로그 확인 필요
- 서버 재시작 후 정확한 변환 과정 추적

================================================================================
                           📋 앞으로 해야 할 일
================================================================================

🔴 긴급 (현재 막힌 부분)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. normalizeTime 함수 디버깅
   - 서버 완전 재시작 (Ctrl+C 후 npm run dev)
   - 디버그 로그 확인:
     🐛 [normalizeTime] Input: ... Type: ...
     🐛 [normalizeTime] ISO converted: ... → ...
   - 왜 00:00-00:00이 나오는지 원인 파악

2. 시간대 변환 문제 해결
   현재 문제: ISO 형식 → HH:MM 변환 시 잘못된 시간 출력

   가능한 해결책:
   A) normalizeTime 함수 수정
      - 현재: new Date(timeStr).getHours()
      - 문제: 서버 시간대에 따라 다름
      - 해결: 명시적으로 한국 시간대로 변환

   B) 챗봇 저장 형식 변경
      - usePreferredTimeAdd.js 수정
      - ISO 형식 대신 HH:MM 형식으로 저장
      - startTime: "09:00", endTime: "12:00"

   C) 서버 시간대 설정 확인
      - process.env.TZ = 'Asia/Seoul' 설정
      - 또는 Docker/서버 환경의 시간대 확인

🟡 중요 (기능 개선)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

3. 데이터 일관성 확보
   - scheduleExceptions의 시간 형식 통일
   - 모든 곳에서 동일한 형식 사용 (HH:MM 권장)

4. 챗봇 저장 로직 개선
   파일: client/src/hooks/useChat/hooks/enhanced/usePreferredTimeAdd.js
   파일: client/src/hooks/useChat/hooks/enhanced/useRecurringPreferredTimeAdd.js

   현재:
   startTime: startDateTime (ISO 형식)
   endTime: endDateTime (ISO 형식)

   개선:
   startTime: "09:00" (HH:MM 형식)
   endTime: "12:00" (HH:MM 형식)

🟢 선택 (추가 개선)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

5. 에러 메시지 개선
   - "방장과 당신의 선호 시간이 겹치지 않습니다"
   - 더 구체적으로: "방장의 선호시간: 09:00-12:00, 당신의 선호시간: 00:00-00:00"

6. 디버그 로그 제거
   - 정상 작동 확인 후 추가한 console.log 제거
   - 또는 개발 모드에서만 출력되도록 수정

7. 테스트 케이스 작성
   - 챗봇으로 추가한 선호시간으로 일정 교환
   - 버튼으로 추가한 선호시간으로 일정 교환
   - 혼합 케이스 (챗봇 + 버튼)

================================================================================
                              관련 파일 목록
================================================================================

클라이언트:
  ✅ client/src/components/calendar/DetailTimeGrid/index.js
  ✅ client/src/components/tabs/ScheduleGridSelector/components/MergedWeekView.js
  ✅ client/src/components/tabs/ScheduleGridSelector/components/DetailedWeekView.js
  🔄 client/src/hooks/useChat/hooks/enhanced/usePreferredTimeAdd.js
  🔄 client/src/hooks/useChat/hooks/enhanced/useRecurringPreferredTimeAdd.js

서버:
  🔄 server/controllers/coordinationExchangeController.js
  ⏳ server/routes/profile.js

================================================================================
                                 참고 사항
================================================================================

1. 시간 형식 차이
   - ISO 형식: "2025-12-03T00:00:00.000Z" (UTC)
   - HH:MM 형식: "09:00" (로컬 시간)
   - 한국 시간대: UTC+9

2. 데이터베이스 구조
   - scheduleExceptions: 특정 날짜의 예외 일정
   - defaultSchedule: 매주 반복되는 기본 일정
   - personalTimes: 개인 시간 (불가능한 시간)

3. 우선순위
   - priority 3: 선호 (진한 파랑)
   - priority 2: 보통 (중간 파랑)
   - priority 1: 조정 가능 (연한 파랑)

================================================================================
