# 이동수단 확정 기능 구현 계획

## 📋 요구사항 정리

### 3. 방장의 첫 번째 자동배정 프로세스
- 방장이 첫 번째로 자동배정을 누르면
- **일반, 대중교통, 자동차, 자전거, 도보** 옵션 선택 가능
- 방장이 옵션을 선택한 후 자동배정을 실행하고 **확정**이 되면
- 예: "대중교통 보기"를 선택했다면
- → **그 이후로는 "대중교통 보기" 모드만 표시**

### 4. 조원들의 뷰
- 조원들은 **이동수단 선택 버튼이 아예 없음**
- 방장이 선택하고 확정한 모드로만 자동으로 표시됨

---

## 🎯 구현 목표

1. **확정 시 이동수단 모드 저장**
   - 방장이 선택한 이동수단 모드를 Room에 저장

2. **확정 후 UI 변경**
   - 방장: 확정된 모드만 표시 (변경 불가)
   - 조원: 이동수단 버튼 완전히 숨김, 확정된 모드로 자동 표시

3. **초기 로딩 시 자동 적용**
   - 확정된 모드가 있으면 자동으로 해당 모드 활성화

---

## 📁 수정할 파일 목록

### 1. 서버 (백엔드)

#### `server/models/room.js`
**목적**: Room 스키마에 확정된 이동수단 모드 저장 필드 추가

**변경사항**:
```javascript
// RoomSchema에 추가
confirmedTravelMode: {
  type: String,
  enum: ['normal', 'transit', 'driving', 'bicycling', 'walking', null],
  default: null
},
confirmedAt: {
  type: Date,
  default: null
}
```

**위치**: Line ~306 (autoConfirmAt 근처)

---

#### `server/controllers/coordinationController.js` (또는 관련 컨트롤러)
**목적**: 확정 시 이동수단 모드를 Room에 저장

**찾아야 할 함수**: `confirmSchedule`

**변경사항**:
```javascript
// confirmSchedule 함수 내부에 추가
router.post('/rooms/:roomId/confirm-schedule', async (req, res) => {
  try {
    const { roomId } = req.params;
    const { travelMode } = req.body; // 클라이언트에서 전달받음

    // ... 기존 확정 로직 ...

    // 확정 시 이동수단 모드 저장
    room.confirmedTravelMode = travelMode || 'normal';
    room.confirmedAt = new Date();
    await room.save();

    res.json({ success: true, confirmedTravelMode: travelMode });
  } catch (error) {
    // ... 에러 처리 ...
  }
});
```

**검색 키워드**: `confirm-schedule`, `confirmSchedule`

---

### 2. 클라이언트 (프론트엔드)

#### `client/src/services/coordinationService.js`
**목적**: 확정 API 호출 시 현재 이동수단 모드 전달

**찾아야 할 함수**: `confirmSchedule`

**변경사항**:
```javascript
confirmSchedule: async (roomId, travelMode) => {
  const response = await fetch(`${API_URL}/api/coordination/rooms/${roomId}/confirm-schedule`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${await auth.currentUser?.getIdToken()}`
    },
    body: JSON.stringify({ travelMode }) // travelMode 전달
  });
  return await response.json();
}
```

---

#### `client/src/components/tabs/CoordinationTab/index.js`
**목적**:
1. 확정 시 현재 `travelMode` 전달
2. 확정된 모드가 있으면 초기 로딩 시 자동 적용

**변경사항**:

1. **확정 함수 수정** (Line ~479)
```javascript
const handleConfirmSchedule = async (skipConfirm = false) => {
  // ... 기존 로직 ...

  try {
    // travelMode를 함께 전달
    const result = await coordinationService.confirmSchedule(
      currentRoom._id,
      travelMode // 현재 선택된 이동수단 모드
    );

    showAlert(
      `${result.confirmedSlotsCount}개의 시간이 확정되었습니다. (모드: ${travelMode})`,
      'success'
    );

    await fetchRoomDetails(currentRoom._id);
  } catch (error) {
    // ... 에러 처리 ...
  }
};
```

2. **초기 로딩 시 확정된 모드 자동 적용**
```javascript
// currentRoom이 로드되면 확정된 모드 자동 적용
useEffect(() => {
  if (currentRoom?.confirmedTravelMode && currentRoom.confirmedTravelMode !== 'normal') {
    handleTravelModeChange(currentRoom.confirmedTravelMode);
  }
}, [currentRoom?._id, currentRoom?.confirmedTravelMode]);
```

---

#### `client/src/components/coordination/TravelModeButtons.js`
**목적**: 조건부 렌더링 - 방장/조원, 확정 전/후에 따라 다른 UI 표시

**새로운 Props 추가**:
```javascript
const TravelModeButtons = ({
  selectedMode = 'normal',
  onModeChange,
  disabled = false,
  isOwner = false,           // 방장 여부
  confirmedTravelMode = null, // 확정된 모드
  currentRoom = null         // 현재 방 정보
}) => {
```

**조건부 렌더링 로직**:
```javascript
// 1. 조원이면 버튼 완전히 숨김
if (!isOwner) {
  return null; // 또는 확정된 모드만 읽기 전용으로 표시
}

// 2. 방장이고 확정 후: 확정된 모드만 표시
if (isOwner && confirmedTravelMode) {
  return (
    <div className="flex items-center gap-2 ml-4">
      <div className="px-3 py-1.5 rounded-lg text-sm font-medium bg-blue-100 text-blue-700 flex items-center gap-1.5">
        <Icon size={16} />
        <span>{label} (확정)</span>
      </div>
      <span className="text-xs text-gray-500">
        ✓ 이동수단이 확정되어 변경할 수 없습니다
      </span>
    </div>
  );
}

// 3. 방장이고 확정 전: 모든 버튼 표시 (기존 로직)
return (
  <div className="flex items-center gap-2 ml-4">
    {modes.map((mode) => {
      // ... 기존 버튼 렌더링 로직 ...
    })}
  </div>
);
```

---

#### `client/src/hooks/useTravelMode.js`
**목적**: 확정된 모드가 있으면 초기 상태를 해당 모드로 설정

**변경사항**:
```javascript
export const useTravelMode = (currentRoom) => {
  // 초기 상태를 확정된 모드로 설정
  const [travelMode, setTravelMode] = useState(
    currentRoom?.confirmedTravelMode || 'normal'
  );

  // ... 기존 로직 ...

  // currentRoom 변경 시 확정된 모드 자동 적용
  useEffect(() => {
    if (currentRoom?.confirmedTravelMode) {
      setTravelMode(currentRoom.confirmedTravelMode);
      // 확정된 모드가 normal이 아니면 자동으로 재계산
      if (currentRoom.confirmedTravelMode !== 'normal') {
        handleModeChange(currentRoom.confirmedTravelMode);
      }
    } else {
      setTravelMode('normal');
      setEnhancedSchedule(null);
      setError(null);
    }
  }, [currentRoom?._id, currentRoom?.confirmedTravelMode]);

  return {
    travelMode,
    handleModeChange,
    isCalculating,
    error,
    enhancedSchedule,
    getCurrentScheduleData,
    getWeekViewData,
    getMonthViewData
  };
};
```

---

## 🔄 구현 순서

### Phase 1: 서버 준비 (백엔드)
1. ✅ `server/models/room.js` - `confirmedTravelMode` 필드 추가
2. ✅ `server/controllers/coordinationController.js` - 확정 API 수정

### Phase 2: 클라이언트 서비스 수정
3. ✅ `client/src/services/coordinationService.js` - API 호출 수정

### Phase 3: UI 및 로직 수정
4. ✅ `client/src/components/tabs/CoordinationTab/index.js` - 확정 함수 및 초기화 로직
5. ✅ `client/src/hooks/useTravelMode.js` - 확정된 모드 자동 적용
6. ✅ `client/src/components/coordination/TravelModeButtons.js` - 조건부 렌더링

### Phase 4: 테스트
7. ✅ 방장 테스트: 자동배정 → 이동수단 선택 → 확정 → 모드 고정 확인
8. ✅ 조원 테스트: 이동수단 버튼 숨김 확인
9. ✅ 재접속 테스트: 확정된 모드로 자동 로딩 확인

---

## 📝 추가 고려사항

### 1. "전체 비우기" 시 확정 모드 초기화?
**옵션 A**: 전체 비우기 시 `confirmedTravelMode`도 null로 초기화 (다시 선택 가능)
**옵션 B**: 확정 모드는 유지 (방 설정으로 간주)

**추천**: 옵션 A (전체 비우기 = 완전 초기화)

### 2. 확정 모드 변경 기능?
- 방장이 확정 후 모드를 변경하고 싶을 수 있음
- 해결책: "전체 비우기" → 다시 자동배정 실행 → 새 모드 선택 → 확정

### 3. 조원 뷰 옵션
**옵션 A**: 이동수단 버튼 완전히 숨김 (깔끔)
**옵션 B**: 확정된 모드만 읽기 전용으로 표시 (정보 제공)

**추천**: 옵션 A (요구사항대로)

---

## 🧪 테스트 시나리오

### 시나리오 1: 방장의 첫 자동배정
1. 방장이 방 생성 및 조원 초대
2. 방장이 "자동 배정 실행" 클릭
3. 이동수단 버튼 표시: 일반, 대중교통, 자동차, 자전거, 도보
4. 방장이 "대중교통" 선택
5. 자동 배정 실행
6. 자동 확정 또는 수동 확정
7. **확인**: 이동수단 버튼이 "대중교통 (확정)" 만 표시되고 변경 불가

### 시나리오 2: 조원의 뷰
1. 조원이 방에 접속
2. **확인**: 이동수단 버튼이 아예 표시되지 않음
3. **확인**: 시간표는 방장이 선택한 "대중교통" 모드로 자동 표시됨

### 시나리오 3: 재접속 테스트
1. 방장 로그아웃 → 다시 로그인 → 방 접속
2. **확인**: 확정된 "대중교통" 모드로 자동 로딩됨

### 시나리오 4: 전체 비우기 후
1. 방장이 "전체 비우기" 클릭
2. **확인**: 이동수단 선택이 다시 가능한지 확인
3. 다시 자동배정 → 다른 모드(자동차) 선택 → 확정
4. **확인**: 새 모드로 확정됨

---

## 📌 핵심 포인트

1. **확정 = 이동수단 고정**
   - 확정 버튼을 누르는 순간 현재 선택된 이동수단 모드가 Room에 저장됨

2. **방장만 이동수단 선택 가능**
   - 조원은 버튼 자체를 볼 수 없음

3. **확정 후 모드 변경 방법**
   - "전체 비우기" → 처음부터 다시 시작

4. **초기 로딩 시 자동 적용**
   - `confirmedTravelMode`가 있으면 자동으로 해당 모드로 시간표 재계산

---

## ✅ 완료 체크리스트

- [ ] Phase 1-1: Room 모델에 `confirmedTravelMode` 필드 추가
- [ ] Phase 1-2: 확정 API에서 `travelMode` 저장 로직 추가
- [ ] Phase 2: coordinationService.js 수정
- [ ] Phase 3-1: CoordinationTab/index.js 수정
- [ ] Phase 3-2: useTravelMode.js 수정
- [ ] Phase 3-3: TravelModeButtons.js 조건부 렌더링 추가
- [ ] Phase 4-1: 방장 시나리오 테스트
- [ ] Phase 4-2: 조원 시나리오 테스트
- [ ] Phase 4-3: 재접속 테스트
- [ ] Phase 4-4: 전체 비우기 테스트

---

## 📅 예상 작업 시간

- 서버 수정: 30분
- 클라이언트 수정: 1시간
- 테스트: 30분
- **총 예상 시간**: 2시간

---

## 🚀 시작하기

작업 시작 시 이 파일을 참고하여 순차적으로 진행하세요.
각 Phase 완료 시 체크리스트에 표시하세요.
