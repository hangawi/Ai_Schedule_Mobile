================================================================================
                   챗봇 확장 기능 구현 및 수정 요약
================================================================================

작성일: 2025년 12월 1일
목적: 프로필 탭 챗봇 기능 확장 - 선호시간/반복 선호시간 추가 기능 구현

================================================================================
                               구현된 기능
================================================================================

1. 선호시간 추가 (usePreferredTimeAdd)
   - 기능: 특정 날짜의 선호시간 추가
   - 예시: "12월 5일 9-12시 선호시간으로 해줘"
   - 우선순위: 선호(3), 보통(2), 조정가능(1)
   - 디폴트: 미지정 시 선호(3)으로 자동 설정
   - 색상: 파란색 계열 (선호=진한파랑, 보통=중간파랑, 조정가능=연한파랑)

2. 반복 선호시간 추가 (useRecurringPreferredTimeAdd)
   - 기능: 여러 날짜에 동시에 선호시간 추가
   - 예시: "이번달 전부 9-12시 선호시간으로"
   - 예시: "이번달 월요일 전부 9-12시 보통으로"
   - AI가 날짜 배열(dates)을 자동 생성하여 전달
   - 각 날짜마다 개별 scheduleException 생성

3. 개인시간 추가 (usePersonalTimeAdd)
   - 기능: 불가능한 시간(개인시간) 추가
   - 예시: "12월 5일 9-12시 개인시간으로 해줘"
   - 색상: 빨간색 (#ef4444)
   - 조율 불가능한 시간으로 처리

================================================================================
                           발생한 문제 및 해결
================================================================================

문제 1: API 키 유출 (403 Forbidden)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
증상: Google이 소스코드에 하드코딩된 API 키를 감지하여 차단
원인: enhanced.js와 App.js에 fallback 키가 하드코딩됨
해결:
  1. 모든 하드코딩된 키 제거
  2. 환경변수만 사용하도록 수정
  3. 새 API 키 발급: AIzaSyC5vs6HmAjDOGjhSI9eZusUfIyrXeqB5v4
  4. 중복 .env 파일 삭제 (.env.development.local, .env.local)

수정된 파일:
  - client/src/hooks/useChat/enhanced.js
  - client/src/App.js
  - client/.env
  - server/.env


문제 2: React Hooks 조건부 호출 (빌드 에러)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
증상: "React Hook is called conditionally" 에러
원인: 삼항 연산자로 hook을 조건부 호출
해결: 두 hook을 모두 호출한 후 결과만 선택

수정 전:
  const { handleChatMessage } = USE_ENHANCED_CHAT
    ? useChatEnhanced(...)
    : useChat(...);

수정 후:
  const chatLegacy = useChat(...);
  const chatEnhanced = useChatEnhanced(...);
  const { handleChatMessage } = USE_ENHANCED_CHAT ? chatEnhanced : chatLegacy;


문제 3: 401 Unauthorized (인증 실패)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
증상: POST /api/users/profile/schedule 401 에러
원인: localStorage.getItem('token') 사용 (잘못된 인증 방식)
해결: Firebase Authentication으로 변경

수정 내용:
  import { auth } from '../../../../config/firebaseConfig';

  const currentUser = auth.currentUser;
  if (!currentUser) {
    throw new Error('로그인이 필요합니다.');
  }

  const serverResponse = await fetch(apiUrl, {
    headers: {
      'Authorization': `Bearer ${await currentUser.getIdToken()}`
    }
  });

수정된 파일:
  - usePreferredTimeAdd.js
  - useRecurringPreferredTimeAdd.js
  - usePersonalTimeAdd.js


문제 4: 404 Not Found (서버 엔드포인트 없음)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
증상: POST /api/users/profile/schedule 404 에러
원인: 서버에 해당 엔드포인트가 존재하지 않음
해결: profile.js에 새 엔드포인트 생성

구현 내용:
  - POST /api/users/profile/schedule
  - scheduleExceptions (선호시간) 배열 저장
  - personalTimes (개인시간) 배열 저장
  - 중복 체크 로직 포함

수정된 파일:
  - server/routes/profile.js


문제 5: 화면 미표시 (성공했으나 화면에 안 보임)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
증상: 서버 저장 성공했으나 화면에 표시되지 않음
원인: useCalendarUpdate.js가 새 이벤트 타입을 처리하지 못함
해결: 새 이벤트 타입 핸들러 추가

추가된 이벤트 타입:
  - 'add_preferred_time'
  - 'add_recurring_preferred_time'
  - 'add_personal_time'

수정된 파일:
  - client/src/components/tabs/ProfileTab/hooks/useCalendarUpdate.js


문제 6: 잘못된 색상 표시 (노란색으로 표시됨)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
증상: 달력에서 선호시간이 노란색(bg-yellow-500)으로 표시됨
원인: CalendarView.js에서 exception 색상이 하드코딩됨
해결: priority 값에 따라 동적으로 색상 적용

색상 매핑:
  - priority 3 (선호): bg-blue-600 (진한 파랑)
  - priority 2 (보통): bg-blue-400 (중간 파랑)
  - priority 1 (조정가능): bg-blue-200 (연한 파랑)

수정된 파일:
  - client/src/components/calendar/CalendarView.js


문제 7: 시간 범위 미표시 (9-12시 대신 9:00만 표시)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
증상: 분할 모드에서 9-12시 범위 중 9:00 하나만 표시됨
원인: getExceptionForSlot이 정확한 시작 시간만 체크
해결: 시간 범위 내에 포함되는지 체크하도록 수정

수정 로직:
  - 슬롯 시간을 분 단위로 변환 (예: 9:00 → 540분)
  - exception의 startTime, endTime도 분 단위로 변환
  - slotMinutes >= exStartMinutes && slotMinutes < exEndMinutes 체크

수정된 파일:
  - client/src/components/calendar/DetailTimeGrid/index.js


문제 8: 변수 선언 충돌 (month 중복 선언)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
증상: "Cannot access 'month' before initialization" 에러
원인: 동일 스코프에서 month 변수 두 번 선언
해결: 내부 스코프 변수명을 dateYear, dateMonth, dateDay로 변경

수정된 파일:
  - client/src/components/calendar/CalendarView.js


문제 9: 중복 추가 허용 (같은 시간 여러 번 추가됨)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
증상: 동일한 시간을 여러 번 추가할 수 있음
요구사항: "이미 추가되어 있어요" 메시지 표시
해결: 서버 측 중복 체크 로직 구현

중복 체크 로직:
  - scheduleExceptions: specificDate, startTime, endTime 비교
  - personalTimes: specificDate, startTime, endTime 비교
  - 중복 시 추가하지 않고 duplicateCount 증가

서버 응답:
  {
    success: true,
    addedCount: 0,           // 실제 추가된 개수
    duplicateCount: 1,       // 중복된 개수
    isDuplicate: true,       // 모두 중복인 경우 true
    scheduleExceptions: [...],
    personalTimes: [...]
  }

클라이언트 처리:
  if (savedData.isDuplicate) {
    return {
      success: true,
      message: '해당 시간은 이미 추가되어 있어요!',
      data: savedData
    };
  }

수정된 파일:
  - server/routes/profile.js
  - usePreferredTimeAdd.js
  - useRecurringPreferredTimeAdd.js
  - usePersonalTimeAdd.js

================================================================================
                              파일 구조
================================================================================

Ai_Schedule/
│
├── client/
│   ├── .env                                    ← 환경변수 (통합)
│   │   ├── REACT_APP_GOOGLE_CLIENT_ID
│   │   ├── REACT_APP_API_URL
│   │   ├── REACT_APP_MY_GOOGLE_KEY            ← Gemini API 키
│   │   └── REACT_APP_GOOGLE_MAPS_API_KEY
│   │
│   └── src/
│       ├── SchedulingSystem.js                 ← 메인 시스템 (hook 선택)
│       ├── App.js                              ← 앱 진입점
│       │
│       ├── hooks/
│       │   └── useChat/
│       │       ├── index.js                    ← Legacy 챗봇 (기존)
│       │       ├── enhanced.js                 ← Enhanced 챗봇 (신규) ★
│       │       │
│       │       ├── hooks/
│       │       │   ├── enhanced/               ← 신규 기능 hooks ★
│       │       │   │   ├── usePreferredTimeAdd.js          (선호시간)
│       │       │   │   ├── useRecurringPreferredTimeAdd.js (반복 선호시간)
│       │       │   │   └── usePersonalTimeAdd.js           (개인시간)
│       │       │   │
│       │       │   └── [기존 legacy hooks]
│       │       │       ├── useEventAdd.js
│       │       │       ├── useEventDelete.js
│       │       │       ├── useEventEdit.js
│       │       │       └── ...
│       │       │
│       │       ├── handlers/
│       │       │   ├── enhancedIntentHandlers.js  ← 신규 intent 핸들러 ★
│       │       │   └── [기존 handlers]
│       │       │
│       │       └── prompts/
│       │           ├── unifiedPrompt.js            ← 통합 프롬프트 ★
│       │           └── [기존 prompts]
│       │
│       └── components/
│           ├── calendar/
│           │   ├── CalendarView.js              ← 월간 달력 뷰
│           │   │                                  (수정: 동적 색상 매핑)
│           │   └── DetailTimeGrid/
│           │       └── index.js                 ← 상세 시간 그리드
│           │                                      (수정: 시간 범위 체크)
│           └── tabs/
│               └── ProfileTab/
│                   └── hooks/
│                       └── useCalendarUpdate.js ← 달력 업데이트 핸들러
│                                                  (수정: 신규 이벤트 타입)
│
└── server/
    ├── .env                                    ← 서버 환경변수
    │   ├── MONGODB_URI
    │   ├── JWT_SECRET
    │   └── GEMINI_API_KEY                      ← Gemini API 키
    │
    └── routes/
        └── profile.js                          ← 프로필 API 라우트
                                                  (신규: POST /schedule)

================================================================================
                           주요 기술 구성
================================================================================

AI/ML:
  - Google Gemini 2.0 Flash (gemini-2.0-flash-exp)
  - 자연어 처리를 통한 인텐트 분류
  - 날짜/시간 파싱 및 우선순위 판단

인증:
  - Firebase Authentication
  - JWT 토큰 (getIdToken())
  - Express middleware (auth)

데이터베이스:
  - MongoDB
  - User 모델 (scheduleExceptions, personalTimes 배열)

프론트엔드:
  - React Hooks (useCallback, useEffect, useState)
  - CustomEvent API (window.dispatchEvent)
  - Tailwind CSS (동적 클래스 적용)

백엔드:
  - Express.js
  - RESTful API
  - 중복 체크 로직

================================================================================
                           우선순위 시스템
================================================================================

선호시간 우선순위:
  1 (조정 가능)  - bg-blue-200 (연한 파랑)
  2 (보통)       - bg-blue-400 (중간 파랑)
  3 (선호)       - bg-blue-600 (진한 파랑)

개인시간:
  - 우선순위 없음
  - bg-red-500 (빨간색)
  - 조율 불가능한 시간

================================================================================
                          데이터 흐름
================================================================================

1. 사용자 입력
   ↓
2. enhanced.js (Gemini AI 호출)
   ↓
3. Intent 분류
   ├─ add_preferred_time → usePreferredTimeAdd
   ├─ add_recurring_preferred_time → useRecurringPreferredTimeAdd
   └─ add_personal_time → usePersonalTimeAdd
   ↓
4. Firebase 인증 (getIdToken)
   ↓
5. POST /api/users/profile/schedule
   ↓
6. 서버 측 중복 체크
   ↓
7. MongoDB 저장
   ↓
8. 응답 (addedCount, duplicateCount, isDuplicate)
   ↓
9. CustomEvent 발생 ('calendarUpdate')
   ↓
10. useCalendarUpdate 리스너
   ↓
11. fetchSchedule() 호출
   ↓
12. 화면 갱신 (CalendarView, DetailTimeGrid)

================================================================================
                          테스트 시나리오
================================================================================

✅ 선호시간 추가:
   입력: "12월 5일 9-12시 선호시간으로 해줘"
   결과: priority=3, 진한 파랑색, 9:00-12:00 범위 표시

✅ 보통 시간 추가:
   입력: "12월 5일 9-12시 보통으로 해줘"
   결과: priority=2, 중간 파랑색

✅ 조정 가능 시간 추가:
   입력: "12월 5일 9-12시 조정 가능으로 해줘"
   결과: priority=1, 연한 파랑색

✅ 반복 선호시간:
   입력: "이번달 전부 9-12시 선호시간으로"
   결과: 이번 달 모든 날짜에 추가

✅ 개인시간 추가:
   입력: "12월 5일 9-12시 개인시간으로 해줘"
   결과: 빨간색, 불가능한 시간으로 표시

✅ 중복 방지:
   입력: 같은 시간 두 번 추가 시도
   결과: "해당 시간은 이미 추가되어 있어요!" 메시지

================================================================================
                           향후 개선 사항
================================================================================

1. AI 성능 개선:
   - 더 다양한 자연어 패턴 학습
   - 컨텍스트 이해 향상
   - 오류 처리 개선

2. 사용자 경험:
   - 로딩 상태 표시
   - 더 상세한 피드백 메시지
   - 실행 취소 기능

3. 데이터 관리:
   - 일괄 편집 기능
   - 내보내기/가져오기
   - 히스토리 기록

4. 성능 최적화:
   - API 호출 최소화
   - 캐싱 전략
   - 렌더링 최적화

================================================================================
                              작성자 노트
================================================================================

이번 구현의 핵심은 기존 시스템을 유지하면서 새로운 기능을 추가하는 것이었습니다.
USE_ENHANCED_CHAT 플래그를 통해 언제든지 기존 시스템으로 되돌릴 수 있도록 설계했으며,
모든 새 기능은 모듈화되어 있어 유지보수가 용이합니다.

특히 중복 체크, 시간 범위 처리, 동적 색상 매핑 등의 세부 기능들이
사용자 경험을 크게 향상시켰습니다.

Firebase Authentication으로의 전환은 보안성을 높였으며,
서버 측 검증을 통해 데이터 무결성을 보장합니다.

================================================================================
